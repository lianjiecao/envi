# Using Harpoon to reproduce NetFlow traces


## NetFlow ##
[**NetFlow**](https://en.wikipedia.org/wiki/NetFlow) is a protocol/feature proposed by Cisco to collect statistical information of IP network traffic. With NetFlow information network administrator can understand characteristics of network traffic and determine if there is any interesting behavior (e.g., security attacks, congestion, etc).

There are 5 different versions of NetFlow: v1, v5 (most popular), v7, v8 and v9. A typical NetFlow setup includes three components:
* **Flow exporter**: installed on switches/routers where traffic go through. It extracts and aggregates flow information (TCP and UDP) and sends it to flow collector via UDP packets.
* **Flow collector**: installed on servers to receive flow information from flow exporter and convert it to readable records.
* **Trace analyzor**: can be installed anywhere, but usually work with flow collector and report certain events based on collected flow records.

Most of NetFlow implementations are either features come with commerical network devices or licensed softwares. Only a few of them are open source:
* **flow-tools**: flow-tools is a set of programs for processing and managing NetFlow exports from Cisco and Juniper routers. It captures Netflow packets generated by flow exporter programs, extracts flow information and store flow records in its own format (```flow-capture```). It can also be used to generate testing flows, convert format and many other things (```flow-gen, flow-send, flow-expor```, etc.). Harpoon used flow-tools records by default.
* **nfdump**: nfdump is similar to flow-tools. It is a toolset to collect and process NetFlow data, sent from NetFlow exporters. It supports NetFlow v1, v5/v7 v9 and IPFIX. It also contains a collector to collect sflow data (```nfcapd, nfdump, nfprofile```, etc).
* **cflowd**: cannot find too much accurate information about this tool.
* **softflowd**: softflowd is a flow exporter program. It listens promiscuously on a network interface and semi-statefully tracks network flows. These flows can be reported using NetFlow v1, v5, and v9 packets.

### Capturing live traffic
To capture live traffic and generate NetFlow information, we can install softflowd ```sudo apt install softflowd``` and run it in the background ```sudo softflowd -n 127.0.0.1:12345 -i em1```. ```-n``` specifies the host and port number where the NetFlow packets are sent to and ```-i``` specifies the interface ```softflowd``` monitors.

Then we need to start a flow collector program on the host and port number specified above. Here we use ```flow-tools``` by running ```flow-capture -w . 0/0/12345 -S5```. ```-w```  indicates the directory to store flow records, ```0/0/12345``` is the IP address and port number the program listens to, and ```-S5``` means it report stats message for every 5 minutes.

Finally, we can use ```flow-print``` to examine the flow information collected.
```bash
cao@cap32:~$ flow-print < traces/2017/2017-10/2017-10-23/ft-v05.2017-10-23.203719-0400 | head -10
srcIP            dstIP            prot  srcPort  dstPort  octets      packets
128.10.130.152   128.10.130.205   6     22       52378    35175       578
128.10.130.205   128.10.130.152   6     52378    22       9541275     1583
128.10.2.5       128.10.130.152   17    53       42138    318         1
128.10.130.152   128.10.2.5       17    42138    53       73          1
128.10.2.5       128.10.130.152   17    53       33507    293         1
128.10.130.152   128.10.2.5       17    33507    53       73          1
128.10.2.5       128.10.130.152   17    53       42537    423         2
128.10.130.152   128.10.2.5       17    42537    53       146         2
128.10.2.5       128.10.130.152   17    53       44092    423         2

```

### Exact NetFlow from existing traces

#### Original pcap trace
To extract NetFlow information from a original pcap trace, we need to replay it using tools like [Tcpreplay](http://tcpreplay.synfin.net/wiki/tcpreplay), make it go through a flow exporter and collecte NetFlow packets using a flow collector. However, some original information of the traffic such as IP addresses and time stamps will be lost although a pcap trace does preserve these information.

Fortunatly, ```softflowd``` does provide a feature that reads packets from a pcap file instead of an interface. Therefore, we can use ```softflowd``` to replay a pcap trace and run ```flow-capture``` to collect NetFlow packets generated by ```softflowd```. And the output of ```flow-capture``` can be directly used by Harpoon. However, I am not 100% sure that collecte NetFlow records match the original trace accurately. Further inspection needs to be performed.

```bash
### Run softflowd to replay pcap file
cao@cap32:~$ softflowd -n 127.0.0.1:12345 -r traces/bigFlows.pcap
softflowd v0.9.9 starting data collection
Exporting flows to [127.0.0.1]:12345
Shutting down after pcap EOF
Shutting down on user request
Number of active flows: 0
Packets processed: 791179
Fragments: 0
Ignored packets: 436 (436 non-IP, 0 too short)
Flows expired: 31375 (22981 forced)
Flows exported: 45251 in 1581 packets (0 failures)

Expired flow statistics:  minimum       average       maximum
  Flow bytes:                  46         10973      17553011
  Flow packets:                 1            25         20909
  Duration:                  0.00s        21.14s       299.82s

Expired flow reasons:
       tcp =         0   tcp.rst =         0   tcp.fin =         0
       udp =         0      icmp =         0   general =         0
   maxlife =         0
over 2 GiB =         0
  maxflows =     22981
   flushed =      8394

Per-protocol statistics:     Octets      Packets   Avg Life    Max Life
           icmp (1):         303783         4266       3.45s     120.16s
           igmp (2):          14144          286     207.89s     250.16s
            tcp (6):      306981085       633894      27.79s     299.82s
           udp (17):       36971693       152733       1.94s     128.82s

### Run flow-capture to collect NetFlow packets
cao@cap32:~/traces$ flow-capture -w . 0/0/12345 -S5
cao@cap32:~/traces$ flow-print -f1 < 2017/2017-11/2017-11-04/ft-v05.2017-11-04.185504-0400 | head -10
cao@cap32:~/traces$ flow-print -f1 < 2017/2017-11/2017-11-04/ft-v05.2017-11-04.185504-0400 | head -20
Sif  SrcIPaddress     DIf  DstIPaddress      Pr SrcP DstP  Pkts  Octets
 StartTime          EndTime             Active   B/Pk Ts Fl

0000 96.43.146.22     0000 172.16.133.109    06 1bb  c12b  166        214828
 1202.13:40:11.331  1202.13:40:23.272     11.941 1294 00 19

0000 172.16.133.109   0000 96.43.146.22      06 c12b 1bb   100        14972
 1202.13:40:11.331  1202.13:40:23.272     11.941 149 00 1d

0000 172.16.133.113   0000 172.16.139.250    06 d91e 1556  4          184
 1202.13:40:11.349  1202.13:40:11.350      0.001 46  00 15

0000 96.43.146.22     0000 172.16.133.109    06 1bb  c12d  27         13477
 1202.13:40:11.411  1202.13:40:23.274     11.863 499 00 1b

0000 172.16.133.109   0000 96.43.146.22      06 c12d 1bb   35         16747
 1202.13:40:11.411  1202.13:40:23.274     11.863 478 00 1f

0000 64.56.203.22     0000 172.16.133.82     06 1bb  ef32  15         14161
 1202.13:40:11.530  1202.13:40:24.386     12.856 944 00 1d

```

#### NetFlow traces
The other type of traces is raw NetFlow traces such as [**Trace 7**](https://www.simpleweb.org/wiki/index.php/Traces). These are the UDP packets sent from flow exporter to flow collector. It can be decoded by ```Wireshark``` (Analyze->Decode As-> add rule to map UDP port to CFLOW). Each "pdu" in the UDP payload represents a flow record.

<img src="https://raw.githubusercontent.com/lianjiecao/envi/master/misc/wireshark_netflow.png" width="640">

However, we cannot directly use the UDP raw packet as input to Harpoon since it only reads the NetFlow information (e.g., payload of raw NetFlow UDP packets). So, we need to extract the payload first. The basic idea is to first use ```tshark``` to extract data section of all packets and then convert the output to binary. Make sure the "\n" is removed from ```tshark``` output. ```pcap2Nfdata()``` method in [genHarpoonConfig.py](https://github.com/lianjiecao/envi/blob/master/genHarpoonConf.py) does this job.



## Harpoon ##
[**Harpoon**](http://cs.colgate.edu/~jsommers/harpoon/) is a flow-level traffic generator that mimics flow characteristics extracted from a NetFlow trace by transfering files of various sizes over TCP or UDP connections. 
"Harpoon uses a set of distributional parameters that can be automatically extracted from NetFlow traces to generate flows that exhibit the same statistical qualities present in measured Internet traces, including temporal and spatial characteristics. Harpoon can be used to generate representative background traffic for application or protocol testing, or for testing network switching hardware."

Harpoon can use ```flow-tools``` format records or raw NetFlow format as input. However, the latter is only the UDP payload in binary described in the previous section. Here are the three steps Harpoon takes to generate appropriate configurations from NetFlow traces.
1. **harpoon_flowproc** reads ```flow-tools``` records or raw NetFlow information (extracted from previous section) as input and generates an intermediate file containing extracted flow information. "-i" is the _IntervalDuration_ Harpoon uses to create sessions.    
"_One of the main tasks of harpoon_flowproc is to organize flow records into a series of "sessions", which are connections between the same IP host pair initiated within some duration of time. The -i option allows the user to specify this duration of time in seconds. By default, a value of 60 seconds is used. This value should also match the value used for the -i to the harpoon_conf.py script._"
    ```bash
    cao@cap32:~$ cat traces/campus_netflow_v5/netflow0_data_binary | harpoon/selfconf/harpoon_flowproc -i 300 -n -w > traces/campus_netflow_v5/netflow0_300_binary_flowproc
    cao@cap32:~$ head -10 traces/campus_netflow_v5/netflow0_300_binary_flowproc
    first-record 1185457649.574
    # src_ip dst_ip < TCP_FLAG src_port dst_port proto flow_start flow_duration n_pkts n_octets >
    0.1.37.93 122.166.69.120 <!WF 6306 80 6 1185457768.554 1.216 34 2118 >
    0.1.37.93 122.166.69.120 <!WF 18838 80 6 1185459349.714 0.96 37 2274 >
    0.1.147.8 122.166.70.50 <!WF 9001 55434 6 1185459257.751 1.984 6 2368 ><!WF 9001 55434 6 1185459267.09 1.728 2 690 >
    0.1.147.8 122.166.70.50 <!WF 9001 55434 6 1185459567.379 0.832 2 690 ><!WF 9001 55434 6 1185459838.22 7.808 8 3198 ><!WF 9001 55434 6 1185459849.229 0 1 1150 ><!WF 9001 55434 6 1185459868.043 0 1 638 ><!WF 9001 55434 6 1185460136.963 5.056 15 1366 ><!WF 9001 55434 6 1185460147.544 12.224 47 56776 ><!WF 9001 55434 6 1185460459.781 1.92 2 690 >
    0.1.210.135 122.166.26.179 <!WF 4288 6822 6 1185459243.86 0.896 8 585 >
    0.1.212.210 122.166.69.120 <!WF 21 38150 6 1185459027.222 2.752 48 4128 ><!WF 80 58840 6 1185459034.52 0 3 447 >
    0.1.212.210 122.166.69.120 <!WF 21 59854 6 1185459383.183 0.896 49 4198 ><!WF 80 43788 6 1185459671.042 0.0639999 5 551 >
    0.1.212.210 122.166.242.187 <!WF 21 2831 6 1185459607.22 0.704 40 3318 ><!WF 56275 2833 6 1185459607.879 0.128 4 1586 ><!WF 21 2837 6 1185459629.134 0.0639999 24 2079 ><!WF 21 2837 6 1185459633.487 0.128 8 1726 ><!WF 21 2837 6 1185459637.135 1.728 5 306 ><!WF 52635 2838 6 1185459638.033 49.024 3299 4944588 >
    0.1.212.210 122.166.242.187 <!WF 21 2870 6 1185460315.908 0.384 42 3192 ><!WF 58733 2871 6 1185460319.299 1.472 53 76598 ><!WF 58733 2871 6 1185460324.646 52.8 3997 5995500 ><!WF 58733 2871 6 1185460380.164 65.024 4212 6318000 ><!WF 58733 2871 6 1185460445.188 22.72 1425 2137500 ><!WF 58733 2871 6 1185460470.593 56.832 3389 5081436 >
    ```
    **Note that**, ```harpoon_flowproc``` only reads the NetFlow part (NetFlow header and flow records) of a UDP NetFlow packet and only consider TCP flows. The program also has problems of converting network byte order to host byte order for flow records and extracting flow time stamps. See our modification [**here**](https://github.com/lianjiecao/envi/blob/master/harpoon_flowproc.cc).
2. **harpoon_conf.py** generates Harpoon configuration files (for server and client) based the intermediate file. "-i" is the same _IntervalDuration_ as in the previous step, "-S" and "-D" are the source and destination IPs and "-p" is the prefix for the output files (server.xml and client.xml).

    ```bash
    cao@cap32:~$ python harpoon/selfconf/harpoon_conf.py -i 300 -S '127.0.0.1/32' -D '127.0.0.1/32' -p traces/campus_netflow_v5/netflow0_300 traces/campus_netflow_v5/netflow0_300_flowproc
    cao@cap32:~$ cat traces/campus_netflow_v5/netflow0_300_tcpclient.xml
    <harpoon_plugins>
        <plugin name="TcpClient" objfile="tcp_plugin.so" maxthreads="21685" personality="client">
            <active_sessions>
            17433 20332 20621 20091 20458 20462 20574 21532 21685 11832
            </active_sessions>
            <interconnection_times>
            3.19999980927 120.015000105 0.253999948502 0.000999927520752 0.0179998874664 50.0879998207 ... ...
            </interconnection_times>
            <address_pool name="client_source_pool">
                <address ipv4="127.0.0.1" port="0"/>
            </address_pool>
            <address_pool name="client_destination_pool">
                <address ipv4="127.0.0.1" port="10000"/>
            </address_pool>
        </plugin>
    </harpoon_plugins>
    cao@cap32:~$ cat traces/campus_netflow_v5/netflow0_300_tcpserver.xml
    <harpoon_plugins>
        <plugin name="TcpServer" objfile="tcp_plugin.so" maxthreads="47" personality="server">
            <active_sessions> 47 </active_sessions>
            <file_sizes>
            531 446 425 336896 864 390 401092 4586 7670 408 2035 399 ... ...
            </file_sizes>
            <address_pool name="server_pool">
                <address ipv4="0.0.0.0" port="10000"/>
            </address_pool>
        </plugin>
    </harpoon_plugins>

    ```
   
3. **harpoon_reconf.py** computes a new value of max number of sessions for the given target rate. "-s" and "-c" are the server and client xml configration files respectively, "-r" is the target rate in _bps_, "-i" is the same option in the previous two steps and "-d" is debug level verbose.
    ```bash
    cao@cap32:~$ python ~/harpoon/selfconf/harpoon_reconf.py -s traces/campus_netflow_v5/test/netflow0_300_tcpserver.xml -c traces/campus_netflow_v5/test/netflow0_300_tcpclient.xml -r 1000000000 -i 300 -d
    target volume:  37500000000.0
    interval duration:  300
    client conf file:  traces/campus_netflow_v5/test/netflow0_300_tcpclient.xml
    server conf file:  traces/campus_netflow_v5/test/netflow0_300_tcpserver.xml
    targetbytes 37500000000.0 simbytes 37530316751 median 22264 mean 22146 stdev 2239.55499584 max 26450 flows 270340
    number of sessions should be 22146 to achieve volume of 37500000000 bytes (1000000000.0 bits/sec)
    ```
    **Note that**, this program only gives a max value, but the client xml file may include multiple values in _<active_sessions>_ section. One way is to proportionally scale all these values based on the computed max session value.
    
Finally, modify the "client_source_pool" and "client_destination_pool" in client xml file and run them separately.

```bash
ubuntu@ids-snd-2:~$ /usr/local/harpoon/run_harpoon.sh -v10 -w300 -f netflow_trace/netflow0_300_tcpclient.xml
ubuntu@ids-rcv-2:~$ /usr/local/harpoon/run_harpoon.sh -v10 -w300 -c -f netflow_trace/netflow0_300_tcpserver.xml
```

## Discussion
The idea of Harpoon is to mimic a network trace by creating TCP flow to transfer files. The start time and file sizes are extracted from NetFlow records. However, it may not be enough to reproduce the distribution of packet transmission mostly due to the underministic flow duration. Packet transmission also depends the network environment (e.g., link capacity, MTU, etc) and the TCP stack on hosts. Also, TCP flow control is designed to utilize the entire link capacity and provide fairness to other flows. In our experiments, the actual transmission rate is very bursty since Harpoon trys to transmit a certain amount of bytes (based on extracted file sizes and number of sessions from NetFlow records) within the given "_IntervalDuration_". Therefore, if the actual environment is different from the original one, the end time/duration of TCP flows will be different. Hence the transmission rates deviate from the original values.

This figure shows averaged TCP rate in Mbps extracted from ```netflow0``` of [this trace](https://traces.simpleweb.org/traces/netflow/netflow1/).

<img src="https://raw.githubusercontent.com/lianjiecao/envi/master/misc/netflow0_60sec_Mbps.png" width="480">

And the figure below shows the actual traffic rate in Mbps generated by Harpoon (with and without Suricata) on our testbed.

<img src="https://raw.githubusercontent.com/lianjiecao/envi/master/misc/netflow0_harpoon.png" width="480">



## Reference
* Converting a PCAP trace to NetFlow format, https://stackoverflow.com/questions/7523366/converting-a-pcap-trace-to-netflow-format
* How to remove Ethernet layer from a pcap file?, https://stackoverflow.com/questions/3870482/how-to-remove-ethernet-layer-from-a-pcap-file
* exporting payload data in binary file, https://ask.wireshark.org/questions/35353/exporting-payload-data-in-binary-file
* Wireshark exporting data, https://www.wireshark.org/docs/wsug_html_chunked/ChIOExportSection.html
* Extracting data payload from pcap capture, https://stackoverflow.com/questions/29370186/extracting-data-payload-from-pcap-capture
* Dump raw packet 'data' field only?, https://ask.wireshark.org/questions/15374/dump-raw-packet-data-field-only
* Is it possible to maintain original Timestamp when using tcpreply?, https://sourceforge.net/p/tcpreplay/mailman/message/34289793/* 
* NetFlow data generation with nfdump and softflowd, http://elf11.github.io/2015/09/10/NetFlows-data-generation.html
* pcap-converter, https://github.com/hbhzwj/pcap-converter
* flow-tools, https://github.com/adsr/flow-tools, 
* Flow-tools Tutorial, https://www.sanog.org/resources/sanog6/gaurab-sanog6-flow-tools.pdf
* nfdump, http://nfdump.sourceforge.net/, https://github.com/phaag/nfdump, 
* softflowd, https://github.com/davidediger/softflowd
* harpoon, http://cs.colgate.edu/~jsommers/harpoon/, https://github.com/jsommers/harpoon


